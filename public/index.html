<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <title>GPT čatbots – Pārmeklēšanas algoritmi</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f5f5f5; display: flex; height: 100vh; flex-direction: column; }
    .sidebar { width: 240px; background-color: #e0e0e0; padding: 20px; box-sizing: border-box; border-right: 1px solid #ccc; }
    .main { flex-grow: 1; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    select, input, button, textarea { width: 100%; font-size: 14px; margin-top: 10px; }
    textarea { resize: vertical; }
    #output { background: #fff; padding: 10px; border: 1px solid #ccc; height: 60vh; overflow-y: auto; }
    .user-message { background-color: #d0f0d0; padding: 8px; margin-bottom: 6px; border-left: 4px solid #4caf50; }
    .assistant-message { background-color: #e0e0ff; padding: 8px; margin-bottom: 6px; border-left: 4px solid #3f51b5; }
    .hidden { display: none; }
    #loading { margin-top: 10px; font-style: italic; color: #333; }
    .dots::after { content: ''; display: inline-block; width: 1em; text-align: left; animation: dots 1s steps(3, end) infinite; }
    @keyframes dots { 0% { content: ''; } 33% { content: '.'; } 66% { content: '..'; } 100% { content: '...'; } }
    h2 { margin-top: 0; }
    #offlineBanner { background-color: #ffcccc; color: #900; padding: 10px; text-align: center; }
  </style>
</head>
<body>

<div id="offlineBanner" class="hidden">
  Savienojums ar datubāzi nav pieejams – saruna netiek saglabāta!
</div>

<div style="display: flex; flex-grow: 1;">
  <div class="sidebar">
    <h3>Iestatījumi</h3>
    <label for="level">Zināšanu līmenis:</label>
    <select id="level">
      <option value="1">1 – Iesācējs</option>
      <option value="2">2 – Vidējs</option>
      <option value="3">3 – Pieredzējis</option>
    </select>

    <label for="language">Programmēšanas valoda:</label>
    <input id="language" type="text" placeholder="Piemēram: Python, Java" />

    <label for="topic">Algoritma tēma:</label>
    <select id="topic">
      <option value="Breadth-First Search">Platuma pārlase (BFS)</option>
      <option value="Depth-First Search">Dziļuma pārlase (DFS)</option>
      <option value="Minimax">Minimax algoritms</option>
      <option value="Alpha-Beta">Alpha-Beta apgriešana</option>
    </select>

    <button id="resetBtn" class="hidden" onclick="resetChat()">Sākt no jauna</button>
  </div>

  <div class="main">
    <h2>GPT čatbots – Pārmeklēšanas algoritmi</h2>
    <h3>GPT atbildes:</h3>
    <div id="output"></div>
    <label for="input">Tavs jautājums:</label>
    <textarea id="input" rows="3" placeholder="Uzdod jautājumu..."></textarea>
    <button id="sendBtn" onclick="sendMessage()">Sūtīt</button>
  </div>
</div>

<script>
let sessionId = null;
let messages = [];
let levelLocked = false;
let languageLocked = false;

function getUserId() {
  let userId = localStorage.getItem("userId");
  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem("userId", userId);
  }
  return userId;
}

function showOfflineBanner() {
  document.getElementById("offlineBanner").classList.remove("hidden");
}

function hideOfflineBanner() {
  document.getElementById("offlineBanner").classList.add("hidden");
}

async function postJSON(url, data) {
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const json = await res.json();

    if (json.mode === "offline") {
      showOfflineBanner();
    } else {
      hideOfflineBanner();
    }

    return json;
  } catch (err) {
    console.error("Tīkla kļūda:", err);
    showOfflineBanner();
    return { mode: "offline" };
  }
}

function appendOutput(who, message) {
  const output = document.getElementById("output");
  const messageDiv = document.createElement("div");
  messageDiv.classList.add(who === "Tu" ? "user-message" : "assistant-message");
  messageDiv.textContent = `${who}: ${message}`;
  output.appendChild(messageDiv);
  output.scrollTop = output.scrollHeight;
}

async function sendMessage() {
  const sendButton = document.getElementById("sendBtn");
  sendButton.disabled = true;

  const userInput = document.getElementById("input").value.trim();
  const levelSelect = document.getElementById("level");
  const languageInput = document.getElementById("language").value.trim();
  const topic = document.getElementById("topic").value.trim();

  if (!userInput || !languageInput || !topic) {
    alert("Aizpildi visus laukus! – Programmēšanas valoda, tēma un jautājums");
    sendButton.disabled = false;
    return;
  }

  if (!levelLocked || !languageLocked) {
    levelSelect.disabled = true;
    document.getElementById("language").disabled = true;
    document.getElementById("topic").disabled = true;
    document.getElementById("resetBtn").classList.remove("hidden");
    levelLocked = true;
    languageLocked = true;

    const startData = await postJSON("/api/start-session", {
      userId: getUserId(),
      levelNum: levelSelect.value,
      languageInput,
      topic
    });
    sessionId = startData.sessionId;
  }

  messages.push({ role: "user", content: userInput });
  appendOutput("Tu", userInput);

  const output = document.getElementById("output");
  const loadingDiv = document.createElement("div");
  loadingDiv.id = "loadingMessage";
  loadingDiv.innerHTML = `<em>Atbilde tiek ģenerēta<span class="dots"></span></em>`;
  output.appendChild(loadingDiv);
  loadingDiv.scrollIntoView({ behavior: "smooth" });

  try {
    const data = await postJSON("/api/chat", {
      messages,
      levelNum: levelSelect.value,
      languageInput,
      userId: getUserId(),
      sessionId,
      topic
    });

    loadingDiv.remove();

    const reply = data.reply || "[Nav atbildes]";
    messages.push({ role: "assistant", content: reply });
    appendOutput("GPT", reply);
  } catch (err) {
    loadingDiv.remove();
    alert("Kļūda, mēģini vēlreiz!");
    console.error(err);
  } finally {
    document.getElementById("input").value = "";
    sendButton.disabled = false;
  }
}

window.addEventListener("load", async () => {
  const userId = getUserId();
  try {
    const data = await postJSON("/api/load-session", { userId });

    if (data.messages && data.messages.length > 0) {
      messages = data.messages;
      const output = document.getElementById("output");
      output.textContent = "";

      for (const msg of messages) {
        const who = msg.role === "user" ? "Tu" : "GPT";
        appendOutput(who, String(msg.content));
      }

      const levelSelect = document.getElementById("level");
      const languageInput = document.getElementById("language");
      const topicSelect = document.getElementById("topic");

      if (data.level === "beginner") levelSelect.value = "1";
      else if (data.level === "intermediate") levelSelect.value = "2";
      else if (data.level === "advanced") levelSelect.value = "3";

      languageInput.value = data.language || "";
      topicSelect.value = data.topic || "";

      sessionId = data.sessionId;

      document.getElementById("resetBtn").classList.remove("hidden");
      levelSelect.disabled = true;
      languageInput.disabled = true;
      topicSelect.disabled = true;
      levelLocked = true;
      languageLocked = true;
    }
  } catch (err) {
    console.error("Neizdevās ielādēt pēdējo sesiju:", err);
    showOfflineBanner();
  }
});

function resetChat() {
  messages = [];
  levelLocked = false;
  languageLocked = false;

  document.getElementById("output").textContent = "";
  document.getElementById("input").value = "";
  document.getElementById("language").value = "";
  document.getElementById("topic").value = "";
  document.getElementById("level").disabled = false;
  document.getElementById("language").disabled = false;
  document.getElementById("topic").disabled = false;
  document.getElementById("resetBtn").classList.add("hidden");
}
</script>
</body>
</html>
